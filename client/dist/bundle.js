class e{constructor(){this.isActive=!1,this.ownerId=null,this.grid=null,this.name="Lily the Ghost",this.movementInterval=null,this.followRange=8,this.loseInterestRange=10,this.normalInterval=3e3,this.followingInterval=1,this.maxMoveDistance=3,this.maxFollowDistance=3,this.flashDistance=5,this.idealDistance=2,this.moveDelay=170,this.sadEmoji="ðŸ˜¢",this.heartEmoji="â¤ï¸",this.flowerItemId="flower",this.serverUrl="http://localhost:3000",this.apiRequestQueue=[],this.isProcessingQueue=!1,this.setupEventListeners(),this.emotion={happiness:50,excitement:50,tiredness:50},this.MAX_EMOTION=100,this.MIN_EMOTION=0,this.emotionDecayInterval=setInterval((()=>this.decayEmotions()),1e3),this.emojiQueue=[],this.isShowingEmoji=!1,this.emojiDuration=3e3,this.lastProcessedMessage="",this.lastProcessedMessageFrom="",this.lastProcessedGroupMessage="",this.lastProcessedGroupMessageFrom="",this.costume={white:{skin:"gV7nljNpXAGHgAEnbBWv",hair:"3ZnyOry7q9szgHCU1URo",facial_hair:"",top:"GOIono5TlL1mMHqoryfb",bottom:"R-mO0WjmRySf-DdFAMmb",shoes:"qXZsUMXd6wr2ICupUTcz",hat:"",glasses:"",other:"",costume:"Mva4mNGosmKAroMHPP5j",mobility:"",jacket:""},orange:{skin:"gV7nljNpXAGHgAEnbBWv",hair:"3ZnyOry7q9szgHCU1URo",facial_hair:"",top:"GOIono5TlL1mMHqoryfb",bottom:"R-mO0WjmRySf-DdFAMmb",shoes:"qXZsUMXd6wr2ICupUTcz",hat:"",glasses:"",other:"",costume:"RwIQhCJaKItQY2O5nQgD",mobility:"",jacket:""},yellow:{skin:"gV7nljNpXAGHgAEnbBWv",hair:"3ZnyOry7q9szgHCU1URo",facial_hair:"",top:"GOIono5TlL1mMHqoryfb",bottom:"R-mO0WjmRySf-DdFAMmb",shoes:"qXZsUMXd6wr2ICupUTcz",hat:"",glasses:"",other:"",costume:"fQKQ0hT47tEiGOK8LH9D",mobility:"",jacket:""},beige:{skin:"gV7nljNpXAGHgAEnbBWv",hair:"3ZnyOry7q9szgHCU1URo",facial_hair:"",top:"GOIono5TlL1mMHqoryfb",bottom:"R-mO0WjmRySf-DdFAMmb",shoes:"qXZsUMXd6wr2ICupUTcz",hat:"",glasses:"",other:"",costume:"arv3Gj35Qeu5vrpg-lTm",mobility:"",jacket:""},gray:{skin:"gV7nljNpXAGHgAEnbBWv",hair:"3ZnyOry7q9szgHCU1URo",facial_hair:"",top:"GOIono5TlL1mMHqoryfb",bottom:"R-mO0WjmRySf-DdFAMmb",shoes:"qXZsUMXd6wr2ICupUTcz",hat:"",glasses:"",other:"",costume:"cKgv0pjT9PWQ5q5Xf4ib",mobility:"",jacket:""},skyblue:{skin:"gV7nljNpXAGHgAEnbBWv",facial_hair:"",hair:"3ZnyOry7q9szgHCU1URo",top:"GOIono5TlL1mMHqoryfb",bottom:"R-mO0WjmRySf-DdFAMmb",shoes:"qXZsUMXd6wr2ICupUTcz",hat:"",glasses:"",other:"",costume:"arv3Gj35Qeu5vrpg-lTm",mobility:"",jacket:""}}}async startBehavior(){this.isActive||(this.isActive=!0,this.initializeGrid(),this.startPeriodicCheck(),await this.scheduleNextBehavior(),console.log("Avatar pet behavior started!"))}stopBehavior(){this.isActive&&(this.isActive=!1,clearTimeout(this.movementInterval),this.ownerId=null,console.log("Avatar pet behavior stopped."))}initializeGrid(){const e=game.completeMaps[game.getMyPlayer().map];if(e){this.grid=new Array(60).fill(null).map((()=>new Array(126).fill(1)));for(let t=0;t<60;t++)for(let s=0;s<126;s++)e.collisions[t]&&e.collisions[t][s]&&(this.grid[t][s]=0)}}async scheduleNextBehavior(){const e=this.ownerId?this.followingInterval:this.normalInterval;await new Promise((t=>setTimeout(t,e))),this.isActive&&(await this.behave(),await this.scheduleNextBehavior())}async behave(){if(game.getMyPlayer())if(Math.random()<(this.ownerId?15e-5:.015)&&this.reactToEmotionalState(),this.ownerId)game.players[this.ownerId]?await this.followPlayer():(this.ownerId=null,this.showEmoji(this.sadEmoji));else{const e=this.findNearbyPlayerToFollow();e?(this.setNewOwner(e.id),await this.followPlayer()):await this.moveFreely()}}}const t={addToRequestQueue(e){return new Promise(((t,s)=>{this.apiRequestQueue.push({message:e,resolve:t,reject:s}),this.processQueue()}))},async processQueue(){if(this.isProcessingQueue||0===this.apiRequestQueue.length)return;this.isProcessingQueue=!0;const{message:e,resolve:t,reject:s}=this.apiRequestQueue.shift();try{t(await this.makeApiRequest(e))}catch(e){s(e)}finally{this.isProcessingQueue=!1,this.processQueue()}},async makeApiRequest(e){console.log("API ìš”ì²­ ì¤‘...",e);try{const t=await fetch(`${this.serverUrl}/generate-response`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:e})});if(console.log("API ì‘ë‹µ:",t),!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return(await t.json()).response}catch(e){throw console.error("Error in API request:",e),e}}},s={showEmoji(e){this.queueEmoji(e)},queueEmoji(e){this.emojiQueue.push(e),this.isShowingEmoji||this.showNextEmoji()},showNextEmoji(){if(0===this.emojiQueue.length)return this.isShowingEmoji=!1,void game.setEmote("");this.isShowingEmoji=!0;const e=this.emojiQueue.shift();game.setEmote(e),console.log(`Avatar pet showed ${e} emoji`),setTimeout((()=>{this.showNextEmoji()}),this.emojiDuration)}},o={updateEmotion(e,t){this.emotion[e]=Math.max(this.MIN_EMOTION,Math.min(this.MAX_EMOTION,this.emotion[e]+t))},decayEmotions(){Object.keys(this.emotion).forEach((e=>{this.emotion[e]=Math.max(this.MIN_EMOTION,this.emotion[e]-1)}))},getEmotionalState(){const{happiness:e,excitement:t,tiredness:s}=this.emotion;return e>80?"very happy":e>60?"happy":e<30?"sad":t>80?"very excited":t>60?"excited":t<30?"bored":s>80?"exhausted":s>60?"tired":s<30?"energetic":"neutral"},reactToEmotionalState(){console.log("emotions : happiness : ",this.emotion.happiness+" excitement : ",this.emotion.excitement+" tiredness : ",this.emotion.tiredness);const e=["ðŸ˜„","ðŸŽ‰","ðŸŽˆ","ðŸŽŠ","ðŸ’–"],t=["ðŸ™‚","â˜€ï¸","ðŸŒ»","ðŸŒˆ","âœ¨"],s=["ðŸ˜¢","â˜ï¸","ðŸŒ§ï¸","ðŸ‚","ðŸ•¯ï¸"],o=["ðŸ¤©","ðŸŽ†","ðŸš€","âš¡","ðŸ”¥"],i=["ðŸ˜ƒ","ðŸŒŸ","ðŸŽµ","ðŸƒâ€â™‚ï¸","ðŸ’«"],n=["ðŸ˜´","ðŸ•°ï¸","ðŸ“š","ðŸ§©","ðŸŽ­"],a=["ðŸ˜«","ðŸ³ï¸","ðŸ›Œ","â˜•","ðŸ§˜â€â™‚ï¸"],r=["ðŸ˜©","ðŸŒ™","ðŸ›‹ï¸","ðŸ§¸","ðŸµ"],h=["ðŸ’ª","ðŸ‹ï¸â€â™‚ï¸","ðŸš´â€â™€ï¸","ðŸ†","ðŸ¥‡"],l=["ðŸ˜","â“","ðŸ¤”","ðŸ§","ðŸ“Š"],c=e=>e[Math.floor(Math.random()*e.length)];switch(this.getEmotionalState()){case"very happy":this.showEmoji(c(e));break;case"happy":this.showEmoji(c(t));break;case"sad":this.showEmoji(c(s));break;case"very excited":this.showEmoji(c(o));break;case"excited":this.showEmoji(c(i));break;case"bored":this.showEmoji(c(n));break;case"exhausted":this.showEmoji(c(a)),this.safeMove(Math.floor(4*Math.random()));break;case"tired":this.showEmoji(c(r));break;case"energetic":this.showEmoji(c(h));break;default:this.showEmoji(c(l))}},reactToVoice(){console.log("Avatar pet is reacting to voice...");const e=["ðŸ‘‚","ðŸŽµ","ðŸ”Š","ðŸ˜ƒ","ðŸ—£ï¸"],t=e[Math.floor(Math.random()*e.length)];this.showEmoji(t)}},i={setupEventListeners(){game.subscribeToEvent("playerShootsConfetti",this.onConfettiShot.bind(this)),game.subscribeToEvent("playerActivelySpeaking",this.onPlayerSpeaking.bind(this))},async startPeriodicCheck(){for(console.log("startPeriodicCheck ë©”ì†Œë“œ ì‹œìž‘"),this.lastMessageCount=0;;){try{const e=await this.navigateToBodyContainer();if(!e){console.log("bodyContainerë¥¼ ì°¾ì§€ ëª»í•¨"),await new Promise((e=>setTimeout(e,2e3)));continue}if(e.length>1){const t=e[0].querySelector(".css-6unyhe > :nth-child(2) > :nth-child(2) > :first-child :first-child");if(t&&t.textContent){const e=t.textContent,s=e.split(":")[0];if(null!=e.split(":")[1]){const t=e.split(":")[1].trim();t===this.lastProcessedGroupMessage&&s===this.lastProcessedGroupMessageFrom||(console.log("ìƒˆ ë©”ì‹œì§€ ë°œê²¬:",t),this.lastProcessedGroupMessageFrom=s,this.lastProcessedGroupMessage=t,this.onPlayerChat({messageText:t}))}}}const t=e[e.length-1],s=t.querySelector(".css-6unyhe > :nth-child(2) > :first-child > :first-child :first-child"),o=t.querySelector(".css-6unyhe > :nth-child(2) > :nth-child(2) > :first-child :first-child");if(o&&o.textContent){const e=s.textContent,t=o.textContent;t===this.lastProcessedMessage&&e===this.lastProcessedMessageFrom||(console.log("ìƒˆ ë©”ì‹œì§€ ë°œê²¬:",t),this.lastProcessedMessageFrom=e,this.lastProcessedMessage=t,this.onPlayerChat({messageText:t}))}else console.log("chatContainerë¥¼ ì°¾ì§€ ëª»í•¨")}catch(e){console.error("ì£¼ê¸°ì  ì²´í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:",e)}await new Promise((e=>setTimeout(e,1e3)))}},async navigateToBodyContainer(){function e(){return document.getElementsByClassName("sendbird-channel-list__body")}function t(){const e=document.querySelector('button[shape="icon"] svg path[d="M15 18l-6-6 6-6"]');if(e){const t=e.closest("button");if(t)return t.click(),console.log("Back button clicked"),!0}return!1}function s(){const e=document.querySelector('button[aria-label="Chat"]');return!!e&&(e.click(),console.log("Chat button clicked"),!0)}const o=2e3;for(let i=0;i<5;i++){let n=e();if(n&&n.length>0)return n;if(console.log(`Attempt ${i+1}: bodyContainer not found, attempting navigation...`),t()){if(await new Promise((e=>setTimeout(e,o))),n=e(),n&&n.length>0)return console.log(`bodyContainer found after clicking back button on attempt ${i+1}`),n}else if(console.log("Back button not found, trying chat button"),s()){if(await new Promise((e=>setTimeout(e,o))),n=e(),n&&n.length>0)return console.log(`bodyContainer found after clicking chat button on attempt ${i+1}`),n}else console.log("Neither back button nor chat button found");i<4&&(console.log("Waiting before next attempt..."),await new Promise((e=>setTimeout(e,o))))}return null},async generateAIResponse(e){try{return await this.addToRequestQueue({message:e,emotion:this.emotion})}catch(e){return console.error("Error generating AI response:",e),"Woof! (AI error)"}},onConfettiShot(e,t){console.log("Confetti shot event received:",t);const s=t.playerId,o=game.players[s],i=game.getMyPlayer();this.isAdjacentAndFacing(o,i)&&this.changeOwner(s)},onPlayerSpeaking(e,t){const s=t.playerId,o=game.players[s],i=game.getMyPlayer();this.isNearby(o,i)&&this.reactToVoice()},async onPlayerChat(e){console.log("onPlayerChat í˜¸ì¶œë¨, data:",e);const t=e.messageText,s=await this.generateAIResponse(t);this.respondToChat(s)},respondToChat(e){console.log("respondToChat í˜¸ì¶œë¨, ì‘ë‹µ:",e),game.setName(e),console.log("ì´ë¦„ì„ ì‘ë‹µìœ¼ë¡œ ë³€ê²½í•¨"),setTimeout((()=>{game.setName(this.name),console.log("8ì´ˆ í›„ ì›ëž˜ ì´ë¦„ìœ¼ë¡œ ë³µêµ¬")}),8e3)}},n={async moveAlongPathSmooth(e){for(const t of e){const e=game.getMyPlayer();if(!e)return;const s=t.x-e.x,o=t.y-e.y,i=this.getDirection(s,o);this.safeMove(i),await new Promise((e=>setTimeout(e,this.moveDelay)))}},getDirection:(e,t)=>Math.abs(e)>Math.abs(t)?e>0?1:0:t>0?3:2,safeMove(e){try{game.move(e)}catch(e){console.log("Error in move:",e)}},async moveFreely(){const e=game.getMyPlayer();if(!e)return;const t=e.x+Math.floor(7*Math.random())-3,s=e.y+Math.floor(7*Math.random())-3,o=this.findPath({x:e.x,y:e.y},{x:t,y:s});if(o.length>1){const e=Math.min(o.length-1,3);await this.moveAlongPathSmooth(o.slice(1,e+1))}Math.random()<.02&&this.performTrick(),this.updateEmotion("happiness",-2),this.updateEmotion("excitement",-1),this.updateEmotion("tiredness",1)},isFacing(e,t){const s=e.x-t.x,o=e.y-t.y;switch(e.direction){case 5:return s>0;case 7:return s<0;case 3:return o>0;case 1:return o<0;case 4:return!0;default:return!1}},async followPlayer(){const e=game.getMyPlayer(),t=game.players[this.ownerId];if(!e||!t)return this.ownerId=null,void this.showEmoji(this.sadEmoji);const s=this.getDistance(e,t);if(s>this.loseInterestRange)return console.log("Target player is too far, losing interest"),this.ownerId=null,void this.showEmoji(this.sadEmoji);if(s>this.flashDistance){this.emojiQueue=[],this.showEmoji("ðŸ’¢");const s=gameSpace.mapId,o=e.x,i=e.y;game.teleport(s,t.x+.1*(o-t.x),t.y+.1*(i-t.y))}else if(s>this.idealDistance){const s=this.findPath({x:e.x,y:e.y},{x:t.x,y:t.y});if(s.length>1){const e=Math.min(s.length-1,this.maxMoveDistance);await this.moveAlongPathSmooth(s.slice(1,e+1))}this.updateEmotion("happiness",5),this.updateEmotion("excitement",3),this.updateEmotion("tiredness",2)}else{if(!this.isFacing(e,t)){const s=t.x-e.x,o=t.y-e.y,i=this.getDirection(s,o);game.move(i,!0)}Math.random()<6e-4&&await this.performTrick()}}};class a{constructor(){this.elements=[]}enqueue(e,t){this.elements.push({element:e,priority:t}),this.elements.sort(((e,t)=>e.priority-t.priority))}dequeue(){return this.elements.shift().element}isEmpty(){return 0===this.elements.length}includes(e){return this.elements.some((t=>t.element.x===e.x&&t.element.y===e.y))}}const r={findPath(e,t){const s=new a,o=new Set,i=new Map,n=new Map,r=new Map;for(s.enqueue(e,0),n.set(this.pointToString(e),0),r.set(this.pointToString(e),this.heuristic(e,t));!s.isEmpty();){const e=s.dequeue();if(e.x===t.x&&e.y===t.y)return this.reconstructPath(i,e);o.add(this.pointToString(e));for(const a of this.getNeighbors(e)){if(o.has(this.pointToString(a)))continue;const h=n.get(this.pointToString(e))+1;(!s.includes(a)||h<n.get(this.pointToString(a)))&&(i.set(this.pointToString(a),e),n.set(this.pointToString(a),h),r.set(this.pointToString(a),n.get(this.pointToString(a))+this.heuristic(a,t)),s.includes(a)||s.enqueue(a,r.get(this.pointToString(a))))}}return[]},getNeighbors(e){const t=[],s=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}];for(const o of s){const s=e.x+o.x,i=e.y+o.y;s>=0&&s<126&&i>=0&&i<60&&1===this.grid[i][s]&&t.push({x:s,y:i})}return t},heuristic:(e,t)=>Math.abs(e.x-t.x)+Math.abs(e.y-t.y),reconstructPath(e,t){const s=[t];for(;e.has(this.pointToString(t));)t=e.get(this.pointToString(t)),s.unshift(t);return s}},h={findNearbyPlayerToFollow(){const e=game.getMyPlayer();if(!e)return null;const t=Object.values(game.players).filter((t=>t.id!==e.id&&this.getDistance(e,t)<=this.followRange));return t.length>0?t.reduce(((t,s)=>{const o=this.getDistance(e,s);return o<t.distance?{player:s,distance:o}:t}),{player:null,distance:1/0}).player:null},setNewOwner(e){this.ownerId=e;const t=game.players[e]?.name||"ì•Œ ìˆ˜ ì—†ìŒ";console.log(`ìƒˆë¡œìš´ ì£¼ì¸ì´ ìƒê²¼ìŠµë‹ˆë‹¤! ì´ë¦„: ${t}, ID: ${e}`),this.updateEmotion("happiness",20),this.updateEmotion("excitement",15),this.updateEmotion("tiredness",-10),this.showEmoji(this.heartEmoji)},changeOwner(e){this.ownerId=e;const t=game.players[e]?.name||"ì•Œ ìˆ˜ ì—†ìŒ";console.log(`ì£¼ì¸ì´ ë°”ë€Œì—ˆìŠµë‹ˆë‹¤! ìƒˆ ì£¼ì¸ì˜ ì´ë¦„: ${t}, ID: ${e}`),this.showEmoji(this.heartEmoji)},isAdjacentAndFacing(e,t){console.log("Checking if player is adjacent and facing target..."),console.log("Player:",e.direction);const s=e.x-t.x,o=e.y-t.y,i=Math.abs(s)+Math.abs(o);if(console.log("Distance:",i,s,o),1!==i)return!1;switch(e.direction){case 5:return 1===s&&0===o;case 7:return-1===s&&0===o;case 3:return 0===s&&1===o;case 1:return 0===s&&-1===o;default:return!1}}},l={async performTrick(){const e=[this.teleportTrick,this.dance,this.spin,this.shootConfetti,this.flip];this.emojiQueue=[];const t=e[Math.floor(Math.random()*e.length)];try{this.isPerformingTrick=!0,await t.call(this)}finally{this.isPerformingTrick=!1}},async teleportTrick(){this.showEmoji("ðŸŒŸ");const e=game.getMyPlayer(),t=gameSpace.mapId,s=e.x,o=e.y;game.move(4),await this.delay(500),await this.changeColor("yellow"),await this.delay(1e3),game.teleport(t,1,57),await this.delay(1e3),game.teleport(t,s,o),await this.delay(1e3),this.changeColor("beige")},async changeColor(e){const t=this.costume[e];game.setCurrentlyEquippedWearables(t)},async dance(){this.showEmoji("ðŸŽµ"),console.log("Dancing!"),game.move(4),await new Promise((e=>{setTimeout((()=>{game.move(3,!0),e()}),4e3)})),console.log("Dance completed!")},async spin(){this.showEmoji("ðŸŒ€"),console.log("Spinning!");const e=[3,1,2,0];let t=0,s=300;return new Promise((o=>{const i=()=>{game.move(e[t%4],!0),t++,t<=50?(s=s<=50?50:.9*s,setTimeout(i,s)):(console.log("Spinning completed!"),o())};setTimeout(i,s)}))},async shootConfetti(){console.log("Shooting confetti!"),this.showEmoji("ðŸŒ¸");const e=[3,1,2,0];let t=0;return new Promise((s=>{const o=setInterval((()=>{game.move(e[t%4],!0),game.shootConfetti(),t++,t>4&&(clearInterval(o),console.log("Confetti shooting completed!"),s())}),800)}))},async flip(){console.log("Flipping!")}},c={getDistance:(e,t)=>Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)),pointToString:e=>`${e.x},${e.y}`,isNearby(e,t,s=5){return this.getDistance(e,t)<=s},delay:async e=>new Promise((t=>setTimeout(t,e)))};Object.assign(e.prototype,n,r,h,i,o,s,t,c,l);const m=function(){const t=new e;return t.startBehavior(),console.log("Custom pet is now running!"),t}();window.pet=m;